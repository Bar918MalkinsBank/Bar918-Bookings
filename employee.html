<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bar918 — Employee Dashboard</title>

<!-- Styles: dark, sleek, brand colors -->
<style>
  :root{
    --blue: #012C4E;
    --gold: #EAD292;
    --mahogany:#4E2A1E;
    --bg: #0f1720;
    --card:#0b1822;
    --muted:#94a3b8;
    --free:#2ecc71;
    --booked:#f2c94c;
    --seated:#2196F3;
    --finished:#ef4444;
    --closed:#6b7280;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:#e6eef8}
  .container{max-width:1200px;margin:18px auto;padding:18px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
  .header{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .title{font-size:20px;color:var(--gold);font-weight:700}
  .controls{margin-left:auto;display:flex;gap:8px;align-items:center}
  input[type="date"], button{padding:8px 10px;border-radius:8px;border:0;background:#071223;color:var(--gold);cursor:pointer}
  .btn{background:var(--blue);color:var(--gold);padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
  .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
  .layout-wrap{display:flex;gap:18px;margin-top:18px;align-items:flex-start}
  .left-col, .right-col{width:45%;background:transparent;padding:6px;border-radius:8px}
  .divider{width:4%;display:flex;align-items:center;justify-content:center}
  .mah{width:6px;background:var(--mahogany);height:400px;border-radius:4px}
  /* precise table map positions with grid rows */
  .map{position:relative;height:420px;background:transparent}
  .table-card{
    position:absolute;
    background:var(--card);
    border-radius:10px;
    border:2px solid rgba(255,255,255,0.06);
    color:var(--gold);
    padding:8px;
    box-shadow:0 6px 18px rgba(0,0,0,0.6);
    min-width:72px;
    min-height:36px;
    display:flex;flex-direction:column;align-items:center;justify-content:center;font-weight:700;font-size:13px;
  }
  .table-card .meta{font-size:12px;font-weight:600;color:var(--muted);margin-top:6px}
  /* size variants */
  .large{width:160px;height:56px}
  .medium{width:110px;height:56px}
  .small{width:84px;height:48px}

  /* color states */
  .free{background:var(--free);color:#012C4E;border-color:rgba(0,0,0,0.15)}
  .booked{background:var(--booked);color:#012C4E;border-color:rgba(0,0,0,0.08)}
  .seated{background:var(--seated);color:#fff}
  .finished{background:var(--finished);color:#fff}
  .closed{background:var(--closed);color:#fff;opacity:0.85}

  /* layout positions (approximate to your image) */
  /* right column tables */
  #t1{ right:12px; top:12px; } /* small */
  #t2{ right:140px; top:12px; width:160px; height:56px } /* large */
  #t3{ right:12px; top:90px; } /* small */
  #t4{ right:120px; top:90px; } /* medium */
  #t5{ right:200px; top:90px; } /* small */
  #t6{ right:70px; top:160px; width:220px; height:56px } /* large */

  /* left column tables */
  #t7{ left:120px; top:10px; width:190px;height:56px } /* large top center left */
  #t8{ left:12px; top:12px } /* small upper-left */
  #t9{ left:200px; top:74px } /* small */
  #t10{ left:100px; top:74px } /* medium */
  #t11{ left:12px; top:74px } /* small */
  #t12{ left:120px; top:140px } /* medium */
  #t13{ left:12px; top:140px } /* medium */
  #t14{ left:100px; top:220px; width:190px;height:56px } /* large bottom left */
  #t15{ left:12px; top:220px } /* small */

  /* snugs at bottom-left */
  #s1{ left:110px; top:300px }
  #s2{ left:190px; top:300px }
  #s3{ left:270px; top:300px }

  /* right column responsive offsets fit inside right-col container — using right: positions above */

  .legend{display:flex;gap:12px;margin-top:12px;align-items:center}
  .legend .item{display:flex;align-items:center;gap:8px}
  .sw{width:18px;height:14px;border-radius:4px;display:inline-block}

  .booking-list{margin-top:14px;background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;max-height:220px;overflow:auto}
  .booking-row{padding:8px;border-bottom:1px solid rgba(255,255,255,0.02);display:flex;justify-content:space-between;gap:8px}
  .booking-row strong{color:var(--gold)}
  .footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
  @media(max-width:900px){
    .layout-wrap{flex-direction:column}
    .mah{height:18px;width:100%}
    .divider{width:100%;display:block}
    .map{height:620px}
  }
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <div class="title">Bar918 — Staff Dashboard</div>
        <div style="font-size:12px;color:var(--muted)">Live floor map · click a table to cycle status (Booked → Seated → Finished → Free)</div>
      </div>

      <div class="controls">
        <label style="color:var(--muted);font-size:13px;margin-right:6px">Date</label>
        <input type="date" id="date" />
        <button class="btn secondary" id="refreshBtn">Refresh</button>
        <button class="btn" id="autoToggle">Auto-refresh: ON</button>
      </div>
    </div>

    <div class="layout-wrap">
      <!-- left map -->
      <div class="left-col">
        <div class="map" id="leftMap">
          <!-- left tables are absolute inside this container -->
          <div class="table-card large free" id="t7"><div>Table 7</div><div class="meta">6 seats</div></div>
          <div class="table-card small free"  id="t8"><div>Table 8</div><div class="meta">4 seats</div></div>
          <div class="table-card small free"  id="t9"><div>Table 9</div><div class="meta">4 seats</div></div>
          <div class="table-card medium free" id="t10"><div>Table 10</div><div class="meta">4 seats</div></div>
          <div class="table-card small free"  id="t11"><div>Table 11</div><div class="meta">4 seats</div></div>
          <div class="table-card medium free" id="t12"><div>Table 12</div><div class="meta">4 seats</div></div>
          <div class="table-card medium free" id="t13"><div>Table 13</div><div class="meta">4 seats</div></div>
          <div class="table-card large free"  id="t14"><div>Table 14</div><div class="meta">6 seats</div></div>
          <div class="table-card small free"  id="t15"><div>Table 15</div><div class="meta">4 seats</div></div>

          <!-- snugs -->
          <div class="table-card small free" id="s1"><div>Snug 1</div><div class="meta">2 seats</div></div>
          <div class="table-card small free" id="s2"><div>Snug 2</div><div class="meta">2 seats</div></div>
          <div class="table-card small free" id="s3"><div>Snug 3</div><div class="meta">2 seats</div></div>
        </div>
      </div>

      <!-- mahogany divider (visual) -->
      <div class="divider"><div class="mah"></div></div>

      <!-- right map -->
      <div class="right-col">
        <div class="map" id="rightMap">
          <div class="table-card small free" id="t1"><div>Table 1</div><div class="meta">4 seats</div></div>
          <div class="table-card large free" id="t2"><div>Table 2</div><div class="meta">6 seats</div></div>
          <div class="table-card small free" id="t3"><div>Table 3</div><div class="meta">4 seats</div></div>
          <div class="table-card medium free" id="t4"><div>Table 4</div><div class="meta">4 seats</div></div>
          <div class="table-card small free" id="t5"><div>Table 5</div><div class="meta">4 seats</div></div>
          <div class="table-card large free" id="t6"><div>Table 6</div><div class="meta">6 seats</div></div>
        </div>
      </div>
    </div>

    <!-- bookings list on the bottom -->
    <div class="footer">
      <div style="flex:1;margin-right:12px">
        <div style="font-weight:700;color:var(--gold);margin-bottom:8px">Bookings for <span id="dayLabel"></span></div>
        <div class="booking-list" id="bookingList"></div>
      </div>

      <div style="width:340px">
        <div style="font-weight:700;color:var(--gold);margin-bottom:8px">Legend</div>
        <div class="legend">
          <div class="item"><span class="sw" style="background:var(--free)"></span> Free</div>
          <div class="item"><span class="sw" style="background:var(--booked)"></span> Booked</div>
          <div class="item"><span class="sw" style="background:var(--seated)"></span> Seated</div>
          <div class="item"><span class="sw" style="background:var(--finished)"></span> Finished</div>
          <div class="item"><span class="sw" style="background:var(--closed)"></span> Closed</div>
        </div>
      </div>
    </div>
  </div>

<!-- Script -->
<script>
/* CONFIG */
const WEBHOOK = 'https://script.google.com/macros/s/AKfycbxALplsL1YhvjozZcJrd68-wZ_J8lG0IavP-B9xY26LD8ug7KnTAF5_gOcC3S5Ktp5S/exec';
const AUTO_REFRESH_MS = 60000;

/* helper: format time display from stored Time value */
function prettyTime(t){
  if(!t) return '';
  try {
    // If t is ISO string
    const d = new Date(t);
    if(!isNaN(d)) return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  } catch(e){}
  return t;
}

/* parse sheets rows -> booking objects (depending on sheet format) */
function mapRowToBooking(row){
  // Support both new and old column orders.
  // Try common header order assumed: Timestamp | Name | Date | Time | Table | Guests | Contact | Notes | Status?
  // row is array of values from sheet.
  return {
    timestamp: row[0],
    name: row[1],
    date: (row[2] instanceof Date) ? row[2].toISOString().split('T')[0] : (row[2] || '').toString().split('T')[0],
    time: (row[3] instanceof Date) ? row[3].toISOString() : (row[3] || ''),
    table: row[4] ? String(row[4]) : '',
    guests: row[5] || '',
    contact: row[6] || '',
    notes: row[7] || '',
    status: row[8] || 'Booked' // if status column present as 9th position
  };
}

/* UI references */
const dateEl = document.getElementById('date');
const refreshBtn = document.getElementById('refreshBtn');
const autoToggle = document.getElementById('autoToggle');
const bookingList = document.getElementById('bookingList');
const dayLabel = document.getElementById('dayLabel');

let autoRefresh = true;
let autoHandle = null;

/* initial date */
dateEl.value = new Date().toISOString().split('T')[0];
dayLabel.textContent = dateEl.value;

/* attach click handlers to table cards to cycle status */
const tableIds = ['t1','t2','t3','t4','t5','t6','t7','t8','t9','t10','t11','t12','t13','t14','t15','s1','s2','s3'];
tableIds.forEach(id=>{
  const el = document.getElementById(id);
  if(!el) return;
  el.addEventListener('click', async ()=>{
    const table = el.id.replace(/[^\dS]/g,'');
    // determine next status
    const current = el.classList.contains('free') ? 'free' :
                    el.classList.contains('booked') ? 'booked' :
                    el.classList.contains('seated') ? 'seated' :
                    el.classList.contains('finished') ? 'finished' :
                    'free';
    const next = (current==='free') ? 'booked' : (current==='booked' ? 'seated' : (current==='seated' ? 'finished' : 'free'));
    // optimistic UI
    el.classList.remove('free','booked','seated','finished','closed');
    el.classList.add(next);
    // POST update to webhook (CORS-safe text/plain)
    try {
      await fetch(WEBHOOK, {
        method: 'POST',
        headers: {'Content-Type':'text/plain;charset=utf-8'},
        body: JSON.stringify({ action:'updateStatus', table: table, status: capitalize(next), date: dateEl.value })
      });
      await loadData();
    } catch(err){ console.error('status update failed',err); loadData(); }
  });
});

/* helpers */
function capitalize(s){ return s.charAt(0).toUpperCase()+s.slice(1); }

/* load data: fetch bookings for date + closed dates */
async function loadData(){
  const date = dateEl.value;
  dayLabel.textContent = date;
  // clear booking list
  bookingList.innerHTML = '<div style="padding:8px;color:var(--muted)">Loading…</div>';

  try{
    // Call backend: use getAll to retrieve bookings & closed dates (backend provides both)
    const res = await fetch(WEBHOOK + '?action=getAll&date=' + encodeURIComponent(date));
    const txt = await res.text();
    const json = JSON.parse(txt);

    // Build bookings array from returned rows — backend returns { tables: [...], closedDates: [...] } in latest design
    // But we need full booking rows — call getBookings for full details
    const res2 = await fetch(WEBHOOK + '?action=getBookings&date=' + encodeURIComponent(date));
    const txt2 = await res2.text();
    const bookings = JSON.parse(txt2).bookings || [];

    // Reset all table states to free
    tableIds.forEach(id=>{
      const el=document.getElementById(id);
      if(el){ el.classList.remove('booked','seated','finished','closed'); el.classList.add('free'); el.querySelector('.meta').style.display='block'; }
    });

    // Mark closed dates (if any)
    const closedDates = json.closedDates || [];
    const closedForDay = (closedDates || []).find(cd => cd.date === date);
    if(closedForDay){
      tableIds.forEach(id=>{ const el=document.getElementById(id); if(el){ el.classList.remove('free'); el.classList.add('closed'); el.querySelector('.meta').style.display='none'; }});
      bookingList.innerHTML = `<div style="padding:10px;color:var(--gold);font-weight:700">Bookings disabled for this date: ${closedForDay.reason || 'No reason provided'}</div>`;
      return;
    }

    // Place bookings on map & build booking list
    if(bookings.length === 0){
      bookingList.innerHTML = '<div style="padding:8px;color:var(--muted)">No bookings for this date</div>';
    } else {
      bookingList.innerHTML = '';
      // bookings: array of objects with keys matching sheet: name, time, table, guests, contact, notes, status
      bookings.forEach(b=>{
        const tableId = 't' + String(b.table).replace('S','').replace(/^0+/,''); // handle S1? we will map S1,S2,S3 separately
        // show on map: find element by table name (tables S1..S3 used with s1, s2, s3)
        let el;
        if(String(b.table).toUpperCase().startsWith('S')) {
          el = document.getElementById('s' + b.table.replace(/[^\d]/g,''));
        } else {
          el = document.getElementById('t' + b.table);
        }
        if(el){
          el.classList.remove('free','booked','seated','finished','closed');
          const st = (b.status || 'Booked').toLowerCase();
          el.classList.add(st === 'booked' ? 'booked' : (st==='seated' ? 'seated' : (st==='finished' ? 'finished' : 'booked')));
          // show booking details inside card (append small label)
          let label = el.querySelector('.guest') || document.createElement('div');
          label.className = 'guest';
          label.style.fontSize='12px';
          label.style.marginTop='6px';
          label.style.color = (st==='booked')?'#012C4E':'#fff';
          label.textContent = (b.name ? b.name : '') + (b.time ? ' • ' + prettyTime(b.time) : '');
          if(!el.querySelector('.guest')) el.appendChild(label);
        }
        // booking list row
        const row = document.createElement('div');
        row.className = 'booking-row';
        row.innerHTML = `<div><strong>${b.name}</strong><div style="font-size:12px;color:var(--muted)">${b.table} • ${prettyTime(b.time)} • ${b.guests} pax</div></div><div style="text-align:right"><div>${b.contact||''}</div><div style="font-size:12px;color:var(--muted)">${b.notes||''}</div></div>`;
        bookingList.appendChild(row);
      });
    }
  } catch(err){
    console.error('loadData error',err);
    bookingList.innerHTML = '<div style="padding:8px;color:#f88">Error loading bookings</div>';
  }
}

/* event handlers */
refreshBtn.addEventListener('click', ()=>loadData());
autoToggle.addEventListener('click', ()=>{
  autoRefresh = !autoRefresh;
  autoToggle.textContent = 'Auto-refresh: ' + (autoRefresh ? 'ON' : 'OFF');
  if(autoRefresh){
    autoHandle = setInterval(loadData, AUTO_REFRESH_MS);
  } else {
    clearInterval(autoHandle);
  }
});
dateEl.addEventListener('change', ()=> loadData());

/* initial load */
loadData();
autoHandle = setInterval(loadData, AUTO_REFRESH_MS);
</script>
</body>
</html>
