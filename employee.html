<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bar918 — Employee Portal</title>
<style>
  :root{
    --blue:#012C4E;
    --gold:#EAD292;
    --mahogany:#4B1E0E;
    --bg:#071223;
    --muted:#9fb0bf;
    --free:#2ecc71; --booked:#f2c94c; --seated:#2196f3; --finished:#ef4444; --closed:#6b7280;
  }
  body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:var(--gold)}
  .wrap{max-width:1200px;margin:20px auto;padding:18px;border-radius:12px}
  .header{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  .title{font-weight:800;font-size:20px;color:var(--gold)}
  .controls{margin-left:auto;display:flex;gap:8px;align-items:center}
  input[type=date], input[type=text], button{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--gold)}
  .floor{display:grid;grid-template-columns:1fr 36px 1fr;gap:14px;margin-top:16px;align-items:start}
  .section{padding:8px}
  .mah{width:8px;background:var(--mahogany);height:420px;border-radius:6px;margin:auto}
  .grid-left, .grid-right{display:grid;grid-template-columns:repeat(3,1fr);gap:18px;align-content:start}
  .snug-row{display:flex;gap:18px;margin-top:12px}
  .card{background:var(--free);color:var(--blue);border-radius:10px;padding:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-weight:800;cursor:pointer;min-height:72px}
  .card.small{min-height:56px}
  .card.large{min-height:72px}
  .card.free{background:var(--free);color:#012C4E}
  .card.booked{background:var(--booked);color:#012C4E}
  .card.seated{background:var(--seated);color:#fff}
  .card.finished{background:var(--finished);color:#fff}
  .card.closed{background:var(--closed);color:#fff;opacity:0.9}
  .meta{font-size:13px;color:rgba(255,255,255,0.85);margin-top:6px}
  .booking-list{margin-top:12px;background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;max-height:260px;overflow:auto}
  .booking-row{display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid rgba(255,255,255,0.03)}
  .controls .btn{background:var(--blue);color:var(--gold);padding:8px 10px;border-radius:6px;border:0;cursor:pointer}
  .legend{display:flex;gap:12px;margin-top:10px}
  .sw{width:18px;height:12px;border-radius:3px;display:inline-block}
  @media(max-width:900px){ .floor{grid-template-columns:1fr;}.mah{display:none}.grid-left,.grid-right{grid-template-columns:repeat(2,1fr)} .snug-row{justify-content:flex-start} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div><div class="title">Bar918 — Staff Dashboard</div><div style="font-size:13px;color:var(--muted)">Click a table to cycle status · Refresh every 60s</div></div>
      <div class="controls">
        <label style="font-size:13px;color:var(--muted)">Date</label>
        <input id="date" type="date">
        <input id="reason" type="text" placeholder="Closure reason (optional)">
        <button id="toggleClose" class="btn">Disable Bookings</button>
        <button id="refresh" class="btn">Refresh</button>
      </div>
    </div>

    <div class="floor">
      <div class="section">
        <div style="font-weight:800;color:var(--gold);margin-bottom:8px">Left side</div>
        <div class="grid-left" id="leftGrid"></div>
        <div class="snug-row" id="snugRow"></div>
      </div>

      <div class="mah"></div>

      <div class="section">
        <div style="font-weight:800;color:var(--gold);margin-bottom:8px">Right side</div>
        <div class="grid-right" id="rightGrid"></div>
      </div>
    </div>

    <div style="display:flex;gap:18px;margin-top:16px">
      <div style="flex:1">
        <div style="font-weight:800;color:var(--gold);margin-bottom:8px">Bookings for <span id="dayLabel"></span></div>
        <div class="booking-list" id="bookingList"></div>
      </div>
      <div style="width:300px">
        <div style="font-weight:800;color:var(--gold);margin-bottom:8px">Legend</div>
        <div class="legend">
          <div class="item"><span class="sw" style="background:var(--free)"></span> Free</div>
          <div class="item"><span class="sw" style="background:var(--booked)"></span> Booked</div>
          <div class="item"><span class="sw" style="background:var(--seated)"></span> Seated</div>
          <div class="item"><span class="sw" style="background:var(--finished)"></span> Finished</div>
          <div class="item"><span class="sw" style="background:var(--closed)"></span> Closed</div>
        </div>
      </div>
    </div>
  </div>

<script>
/* CONFIG */
const WEBHOOK = 'https://script.google.com/macros/s/AKfycbxALplsL1YhvjozZcJrd68-wZ_J8lG0IavP-B9xY26LD8ug7KnTAF5_gOcC3S5Ktp5S/exec';
const LEFT_TABLES = [
  { number: 7, seats: 6 }, { number: 8, seats: 4 }, { number: 9, seats: 4 },
  { number: 10, seats: 4 }, { number: 11, seats: 4 }, { number: 12, seats: 4 },
  { number: 13, seats: 4 }, { number: 14, seats: 6 }, { number: 15, seats: 4 }
];
const RIGHT_TABLES = [
  { number: 1, seats: 4 }, { number: 2, seats: 6 }, { number: 3, seats: 4 },
  { number: 4, seats: 4 }, { number: 5, seats: 4 }, { number: 6, seats: 6 }
];
const SNUGS = [ {number:'S1', seats:2}, {number:'S2', seats:2}, {number:'S3', seats:2} ];

const leftGrid = document.getElementById('leftGrid');
const rightGrid = document.getElementById('rightGrid');
const snugRow = document.getElementById('snugRow');
const dateEl = document.getElementById('date');
const refreshBtn = document.getElementById('refresh');
const toggleBtn = document.getElementById('toggleClose');
const reasonInput = document.getElementById('reason');
const bookingList = document.getElementById('bookingList');
const dayLabel = document.getElementById('dayLabel');

dateEl.value = new Date().toISOString().split('T')[0];
dayLabel.textContent = dateEl.value;

/* helpers */
function mkCard(t){
  const el = document.createElement('div');
  el.className = 'card ' + (t.seats===2 ? 'small' : t.seats===6 ? 'large' : 'medium') + ' free';
  el.dataset.table = String(t.number);
  el.innerHTML = `<div>Table ${t.number}</div><div class="meta">${t.seats} seats</div>`;
  el.addEventListener('click', async ()=>{
    // cycle status
    const current = el.classList.contains('free') ? 'free' : el.classList.contains('booked') ? 'booked' : el.classList.contains('seated') ? 'seated' : el.classList.contains('finished') ? 'finished' : 'free';
    const next = (current==='free') ? 'booked' : (current==='booked' ? 'seated' : (current==='seated' ? 'finished' : 'free'));
    // preserve size class
    const size = el.classList.contains('large') ? 'large' : el.classList.contains('small') ? 'small' : 'medium';
    el.className = `card ${size} ${next}`;
    // POST update to backend
    try{
      await fetch(WEBHOOK, { method:'POST', headers: {'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify({ action:'updateStatus', table: el.dataset.table, status: next, date: dateEl.value }) });
      await loadData();
    }catch(e){ console.error('update failed',e); await loadData(); }
  });
  return el;
}

function buildGrid(){
  LEFT_TABLES.forEach(t => leftGrid.appendChild(mkCard(t)));
  SNUGS.forEach(s => snugRow.appendChild(mkCard(s)));
  RIGHT_TABLES.forEach(t => rightGrid.appendChild(mkCard(t)));
}

/* loadData fetch bookings + closedDates + display map */
async function loadData(){
  const date = dateEl.value;
  dayLabel.textContent = date;
  bookingList.innerHTML = '<div style="padding:8px;color:var(--muted)">Loading…</div>';

  // reset
  document.querySelectorAll('.card').forEach(c => {
    const size = c.classList.contains('large') ? 'large' : c.classList.contains('small') ? 'small' : 'medium';
    c.className = `card ${size} free`;
    const guest = c.querySelector('.guest'); if(guest) guest.remove();
  });

  try{
    // get all bookings for the day
    const res = await fetch(WEBHOOK + '?action=getBookings&date=' + encodeURIComponent(date));
    const txt = await res.text();
    const json = JSON.parse(txt);
    const bookings = json.bookings || [];

    // get closedDates info
    const res2 = await fetch(WEBHOOK + '?action=getAll&date=' + encodeURIComponent(date));
    const txt2 = await res2.text();
    const json2 = JSON.parse(txt2);
    const closedDates = json2.closedDates || [];
    const closedToday = closedDates.find(c => c.date === date);
    if(closedToday){
      // mark closed
      document.querySelectorAll('.card').forEach(c => {
        const size = c.classList.contains('large') ? 'large' : c.classList.contains('small') ? 'small' : 'medium';
        c.className = `card ${size} closed`;
      });
      bookingList.innerHTML = `<div style="padding:12px;color:var(--gold);font-weight:700">Bookings disabled for ${date}: ${closedToday.reason||'No reason'}</div>`;
      reasonInput.value = closedToday.reason || '';
      toggleBtn.textContent = 'Enable Bookings';
      return;
    } else {
      toggleBtn.textContent = 'Disable Bookings';
      reasonInput.value = '';
    }

    // Display bookings on map and list
    if(bookings.length === 0){
      bookingList.innerHTML = '<div style="padding:8px;color:var(--muted)">No bookings for this date</div>';
    } else {
      bookingList.innerHTML = '';
      bookings.forEach(b=>{
        // map to element
        const key = String(b.table || '');
        let el = null;
        if(/^S/i.test(key)) el = document.querySelector('.card[data-table="'+key+'"]');
        else el = document.querySelector('.card[data-table="'+key+'"]');
        if(el){
          const size = el.classList.contains('large') ? 'large' : el.classList.contains('small') ? 'small' : 'medium';
          el.className = `card ${size} ${ (b.status||'Booked').toLowerCase() }`;
          // add guest snippet
          let guest = el.querySelector('.guest');
          if(!guest){ guest = document.createElement('div'); guest.className='guest'; guest.style.fontSize='13px'; guest.style.marginTop='8px'; el.appendChild(guest); }
          guest.textContent = `${b.name || ''}${b.time ? ' • ' + (new Date(b.time)).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : ''}`;
        }
        // add booking to list
        const row = document.createElement('div'); row.className='booking-row';
        row.innerHTML = `<div><strong>${b.name}</strong><div style="font-size:12px;color:var(--muted)">${b.table} • ${(new Date(b.time)).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} • ${b.guests||''} pax</div></div><div style="text-align:right">${b.contact||''}<div style="font-size:12px;color:var(--muted)">${b.notes||''}</div></div>`;
        bookingList.appendChild(row);
      });
    }

  }catch(err){
    console.error('loadData error', err);
    bookingList.innerHTML = '<div style="padding:8px;color:#f88">Error loading bookings</div>';
  }
}

/* toggle close/open */
toggleBtn.addEventListener('click', async ()=>{
  const date = dateEl.value;
  const reason = reasonInput.value || '';
  // check if closed already
  const r = await fetch(WEBHOOK + '?action=getAll&date=' + encodeURIComponent(date));
  const j = JSON.parse(await r.text());
  const closedList = j.closedDates || [];
  const closedToday = closedList.find(x => x.date === date);
  if(closedToday){
    // open
    await fetch(WEBHOOK, { method:'POST', headers: {'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify({ action:'openDay', date }) });
  } else {
    // close
    await fetch(WEBHOOK, { method:'POST', headers: {'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify({ action:'closeDay', date, reason }) });
  }
  await loadData();
});

refreshBtn.addEventListener('click', ()=>loadData());
dateEl.addEventListener('change', ()=>loadData());

/* build & initial load */
buildGrid = () => {
  LEFT_TABLES.forEach(t => leftGrid.appendChild(mkCard(t)));
  SNUGS.forEach(s => snugRow.appendChild(mkCard(s)));
  RIGHT_TABLES.forEach(t => rightGrid.appendChild(mkCard(t)));
};
/* small helper to reuse mkCard for employee page */
function mkCard(t){ const el=document.createElement('div'); el.className='card '+(t.seats===2?'small':t.seats===6?'large':'medium')+' free'; el.dataset.table=String(t.number); el.innerHTML=`<div>Table ${t.number}</div><div class="meta">${t.seats} seats</div>`; el.addEventListener('click', async ()=>{const current = el.classList.contains('free')?'free':el.classList.contains('booked')?'booked':el.classList.contains('seated')?'seated':el.classList.contains('finished')?'finished':'free'; const next=(current==='free'?'booked':(current==='booked'?'seated':(current==='seated'?'finished':'free'))); const size = el.classList.contains('large')?'large':el.classList.contains('small')?'small':'medium'; el.className=`card ${size} ${next}`; try{ await fetch(WEBHOOK,{ method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify({ action:'updateStatus', table: el.dataset.table, status: next, date: dateEl.value }) }); await loadData(); }catch(e){ console.error(e); await loadData(); } }); return el; }

buildGrid();
loadData();
setInterval(loadData, 60000);
</script>
</body>
</html>
